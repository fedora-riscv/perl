From c28861b92c21957858b840da14b9734f4436b3be Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Petr=20P=C3=ADsa=C5=99?= <ppisar@redhat.com>
Date: Wed, 5 Oct 2011 16:45:43 +0200
Subject: [PATCH] Fix CVE-2011-2939

Fixes heap overflow while decoding Unicode string. See
<https://bugzilla.redhat.com/show_bug.cgi?id=731246> for more
details. Original patch by Robert Zacek <zacek@avast.com>.
---
 cpan/Encode/Unicode/Unicode.xs |    5 ++++-
 1 files changed, 4 insertions(+), 1 deletions(-)

diff --git a/cpan/Encode/Unicode/Unicode.xs b/cpan/Encode/Unicode/Unicode.xs
index 07d7e25..af5965d 100644
--- a/cpan/Encode/Unicode/Unicode.xs
+++ b/cpan/Encode/Unicode/Unicode.xs
@@ -256,7 +256,10 @@ CODE:
 	       This prevents allocating too much in the rogue case of a large
 	       input consisting initially of long sequence uft8-byte unicode
 	       chars followed by single utf8-byte chars. */
-	    STRLEN remaining = (e - s)/usize;
+	    /* +1 
+	       fixes  Unicode.xs!decode_xs n-byte heap-overflow
+	      */
+	    STRLEN remaining = (e - s)/usize + 1; /* +1 to avoid the leak */
 	    STRLEN max_alloc = remaining + (8*1024*1024);
 	    STRLEN est_alloc = remaining * UTF8_MAXLEN;
 	    STRLEN newlen = SvLEN(result) + /* min(max_alloc, est_alloc) */
-- 
1.7.6.4

